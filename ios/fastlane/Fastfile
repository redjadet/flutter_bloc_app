# iOS Fastlane: Ad Hoc, TestFlight, and App Store distribution.
# Run from project root: bundle exec fastlane ios [adhoc|testflight|appstore|deploy]
# Prerequisites: Xcode, Apple Developer account, ./tool/ios_entitlements.sh distribution for App Store/TestFlight/Ad Hoc.

default_platform(:ios)

platform :ios do
  # Switch to distribution entitlements (required for Ad Hoc, TestFlight, App Store).
  def ensure_distribution_entitlements
    project_root = File.expand_path("../..", __dir__)
    sh("cd #{project_root} && ./tool/ios_entitlements.sh distribution")
  end

  # Build IPA with gym (Xcode archive + export). export_method: "ad-hoc" | "app-store"
  def build_ipa(export_method:, output_dir: nil)
    ensure_distribution_entitlements
    output_dir ||= File.expand_path("../../build/ios/ipa", __dir__)
    gym(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: export_method,
      output_directory: output_dir,
      clean: true
    )
  end

  # Ad Hoc: build and export IPA for direct install to registered devices (no TestFlight).
  # Devices must be registered in Apple Developer and included in the Ad Hoc provisioning profile.
  lane :adhoc do
    build_ipa(export_method: "ad-hoc")
    UI.success("Ad Hoc IPA exported. Distribute to registered devices (e.g. via Firebase App Distribution or direct install).")
  end

  # TestFlight: build and upload to App Store Connect for TestFlight beta distribution.
  # Uses App Store provisioning. Add testers in App Store Connect → TestFlight.
  lane :testflight do
    ensure_distribution_entitlements
    gym(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      clean: true
    )
    upload_to_testflight(
      skip_waiting_for_build_processing: false,
      distribute_external: false
    )
    UI.success("Build uploaded to TestFlight. Add testers in App Store Connect → TestFlight.")
  end

  # App Store: build and upload to App Store Connect (same as TestFlight upload).
  # Build appears in TestFlight and in the App Store build list; submit for review in App Store Connect.
  lane :appstore do
    ensure_distribution_entitlements
    gym(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      clean: true
    )
    upload_to_testflight(
      skip_waiting_for_build_processing: false,
      distribute_external: false
    )
    UI.success("Build uploaded to App Store Connect. Select it for a version and submit for review in App Store Connect.")
  end

  # Deploy: alias for TestFlight (backward compatibility with docs).
  lane :deploy do
    testflight
  end
end
